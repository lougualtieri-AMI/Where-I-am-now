<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Where Am I?</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { 
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .slide-in { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-slate-900">
  <div id="app" class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-4"></div>

  <script>
    // ===== YOUR LOCATIONS =====
    const MY_LOCATIONS = [
      { 
        name: 'Home', 
        lat: 27.3412, 
        lng: -82.5463,
        icon: 'home',
        color: '#6366f1',
        apps: ['Lutron', 'Sensi', 'Gemini', 'Claude', 'Chrome', 'NotebookLM'],
        radius: 0.15 // tight - about 800 feet
      },
      { 
        name: 'LA Fitness', 
        lat: 27.3106, 
        lng: -82.5319,
        icon: 'dumbbell',
        color: '#e53935',
        apps: ['LA Fitness', 'YouTube', 'YouTube TV'],
        radius: 0.15 // tight
      },
      { 
        name: 'Laurel Oak', 
        lat: 27.3320, 
        lng: -82.4550,
        icon: 'flag',
        color: '#2e7d32',
        apps: ['Laurel Oak CC', 'Garmin Golf'],
        radius: 1.5 // very large - 36 holes is a big course
      },
      { 
        name: 'Freedom Boat - Marina Plaza', 
        lat: 27.3330, 
        lng: -82.5574,
        icon: 'anchor',
        color: '#0288d1',
        apps: ['Savvy Navvy', 'Life360', 'Google Maps'],
        isBoat: true,
        radius: 0.15 // tight
      },
      { 
        name: 'Freedom Boat - S Tamiami', 
        lat: 27.2753, 
        lng: -82.5150,
        icon: 'anchor',
        color: '#0288d1',
        apps: ['Savvy Navvy', 'Life360', 'Google Maps'],
        isBoat: true,
        radius: 0.15 // tight
      },
      { 
        name: 'Downtown Sarasota', 
        lat: 27.3364, 
        lng: -82.5407,
        icon: 'building-2',
        color: '#8b5cf6',
        apps: ['ParkMobile', 'Google Maps'],
        radius: 0.5 // wider for downtown area
      },
      { 
        name: 'St. Armands Circle', 
        lat: 27.3153, 
        lng: -82.5761,
        icon: 'shopping-bag',
        color: '#ec4899',
        apps: ['ParkMobile', 'Google Maps'],
        radius: 0.4 // wider for shopping area
      }
    ];

    // ===== YOUR APPS =====
    const ALL_APPS = [
      { name: 'Lutron', icon: 'lightbulb', appStore: 'https://play.google.com/store/apps/details?id=com.lutron.mmw', color: '#fbbf24' },
      { name: 'Sensi', icon: 'thermometer', appStore: 'https://play.google.com/store/apps/details?id=com.emerson.sensi', color: '#ef4444' },
      { name: 'Gemini', icon: 'sparkles', appStore: 'https://play.google.com/store/apps/details?id=com.google.android.apps.bard', color: '#4285f4' },
      { name: 'Claude', icon: 'bot', appStore: 'https://play.google.com/store/apps/details?id=com.anthropic.claude', color: '#d97706' },
      { name: 'Chrome', icon: 'chrome', appStore: 'https://play.google.com/store/apps/details?id=com.android.chrome', color: '#4285f4' },
      { name: 'NotebookLM', icon: 'notebook-pen', appStore: 'https://play.google.com/store/apps/details?id=com.google.android.apps.notebooklm', color: '#9333ea' },
      { name: 'LA Fitness', icon: 'dumbbell', appStore: 'https://play.google.com/store/apps/details?id=com.lafitness.lafitness', color: '#e53935' },
      { name: 'YouTube', icon: 'play', appStore: 'https://play.google.com/store/apps/details?id=com.google.android.youtube', color: '#ff0000' },
      { name: 'YouTube TV', icon: 'tv', appStore: 'https://play.google.com/store/apps/details?id=com.google.android.apps.youtube.unplugged', color: '#ff0000' },
      { name: 'Laurel Oak CC', icon: 'flag', appStore: 'https://play.google.com/store/apps/details?id=axis_android.axis_android.LaurelOakCountryClubPrivate2016', color: '#2e7d32' },
      { name: 'Garmin Golf', icon: 'circle-dot', appStore: 'https://play.google.com/store/apps/details?id=com.garmin.android.apps.golf', color: '#007dc3' },
      { name: 'Savvy Navvy', icon: 'compass', appStore: 'https://play.google.com/store/apps/details?id=com.savvynavvy.savvynavvy', color: '#1e88e5' },
      { name: 'Life360', icon: 'users', appStore: 'https://play.google.com/store/apps/details?id=com.life360.android.safetymapd', color: '#9c27b0' },
      { name: 'Google Maps', icon: 'map', appStore: 'https://play.google.com/store/apps/details?id=com.google.android.apps.maps', color: '#4285f4' },
      { name: 'ParkMobile', icon: 'car', appStore: 'https://play.google.com/store/apps/details?id=net.sharewire.parkmobilev2', color: '#00b140' },
      { name: 'Publix', icon: 'shopping-cart', appStore: 'https://play.google.com/store/apps/details?id=com.publix.pharmacy', color: '#3d8b40' },
      { name: 'CVS Pharmacy', icon: 'pill', appStore: 'https://play.google.com/store/apps/details?id=com.cvs.launchers.cvs', color: '#cc0000' },
    ];

    const LOCAL_SUGGESTIONS = [
      { name: 'Siesta Key Beach', desc: 'World-famous white sand beach', icon: 'waves', distance: '4.2 mi' },
      { name: 'St. Armands Circle', desc: 'Upscale shopping & dining', icon: 'store', distance: '2.1 mi' },
      { name: 'Marie Selby Gardens', desc: 'Botanical gardens on the bay', icon: 'tree-pine', distance: '1.5 mi' },
      { name: 'The Ringling Museum', desc: 'Art museum & circus history', icon: 'building-2', distance: '3.8 mi' },
    ];

    const AREA_DESCRIPTION = "Sarasota is a city on Florida's Gulf Coast known for its beaches, arts scene, and cultural attractions. The area features beautiful barrier islands, world-class museums, and a vibrant downtown with excellent dining.";

    let state = {
      location: null,
      loading: true,
      showDetails: false,
      showApps: false,
      showNearby: false,
      nearbyMode: 'land',
      nearbyPlaces: null,
      loadingNearby: false,
      nearestLocation: null,
      onWater: false,
      boatModeActive: false,
      error: null
    };

    let isSpeaking = false;

    // Calculate distance between two points in miles
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Find nearest named location
    function findNearestLocation(lat, lng) {
      let nearest = null;
      let minDist = Infinity;
      
      for (const loc of MY_LOCATIONS) {
        const dist = getDistance(lat, lng, loc.lat, loc.lng);
        const radius = loc.radius || 0.5; // default 0.5 miles if not specified
        
        // Only consider if within this location's radius
        if (dist <= radius && dist < minDist) {
          minDist = dist;
          nearest = { ...loc, distance: dist };
        }
      }
      
      return nearest;
    }

    // Check if likely on water (away from boat launch but boat mode was activated)
    function checkIfOnWater(lat, lng) {
      // Check if near any boat launch
      const boatLocations = MY_LOCATIONS.filter(l => l.isBoat);
      for (const loc of boatLocations) {
        const dist = getDistance(lat, lng, loc.lat, loc.lng);
        if (dist <= 0.3) {
          return false; // At the dock
        }
      }
      return state.boatModeActive; // On water if boat mode was activated
    }

    // Get apps for current location
    function getAppsForLocation() {
      if (state.boatModeActive || state.onWater) {
        // On water - show boat apps
        const boatApps = ['Savvy Navvy', 'Life360', 'Google Maps'];
        return ALL_APPS.filter(app => boatApps.includes(app.name));
      }
      
      if (state.nearestLocation) {
        // Near a known location - show those apps first
        const locationApps = state.nearestLocation.apps || [];
        const priorityApps = ALL_APPS.filter(app => locationApps.includes(app.name));
        const otherApps = ALL_APPS.filter(app => !locationApps.includes(app.name));
        return [...priorityApps, ...otherApps];
      }
      
      // Default - show all apps
      return ALL_APPS;
    }

    function activateBoatMode() {
      state.boatModeActive = true;
      state.nearbyMode = 'water';
      render();
    }

    function deactivateBoatMode() {
      state.boatModeActive = false;
      state.nearbyMode = 'land';
      render();
    }

    function stopSpeaking() {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
      isSpeaking = false;
      render();
    }

    function readAloudSystem(text) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Google')) 
                            || voices.find(v => v.lang.startsWith('en'));
        if (preferredVoice) utterance.voice = preferredVoice;
        
        utterance.onstart = () => { isSpeaking = true; render(); };
        utterance.onend = () => { isSpeaking = false; render(); };
        utterance.onerror = () => { isSpeaking = false; render(); };
        
        window.speechSynthesis.speak(utterance);
      }
    }

    function readAreaDescription() {
      const text = `You're in ${state.location.city}, ${state.location.state}. ${AREA_DESCRIPTION}. Nearby highlights include ${LOCAL_SUGGESTIONS.map(s => s.name).join(', ')}.`;
      readAloudSystem(text);
    }

    function readAloudSpeechify() {
      const text = `You're in ${state.location.city}, ${state.location.state}. ${AREA_DESCRIPTION}. Nearby highlights include ${LOCAL_SUGGESTIONS.map(s => s.name).join(', ')}.`;
      const encodedText = encodeURIComponent(text);
      window.location.href = `intent:#Intent;action=android.intent.action.SEND;type=text/plain;S.android.intent.extra.TEXT=${encodedText};package=com.cliffweitzman.speechify2;end`;
    }
    
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }

    function openApp(app) {
      const packageName = app.appStore.split('id=')[1];
      window.location.href = `intent://launch/#Intent;scheme=app;package=${packageName};S.browser_fallback_url=${encodeURIComponent(app.appStore)};end`;
    }

    async function fetchNearbyPlaces() {
      if (!state.location) return;
      
      state.loadingNearby = true;
      state.showNearby = true;
      state.showDetails = false;
      state.showApps = false;
      render();

      try {
        const { lat, lng } = state.location;
        const radius = state.nearbyMode === 'water' ? 0.008 : 0.004;
        
        state.nearbyPlaces = [];
        
        const searchTypes = state.nearbyMode === 'water' 
          ? ['marina', 'restaurant', 'town', 'village', 'island', 'beach', 'pier', 'dock']
          : ['restaurant', 'cafe', 'shop', 'store', 'bank', 'pharmacy', 'gas', 'hotel', 'park'];
        
        for (const type of searchTypes.slice(0, 4)) {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&limit=3&bounded=1&viewbox=${lng-radius},${lat+radius},${lng+radius},${lat-radius}&q=${type}`
            );
            const data = await response.json();
            
            if (data && data.length > 0) {
              data.forEach(place => {
                const name = place.display_name.split(',')[0];
                const address = place.display_name.split(',').slice(1, 2).join('').trim();
                if (!state.nearbyPlaces.find(p => p.name === name)) {
                  const dLat = Math.abs(place.lat - lat);
                  const dLng = Math.abs(place.lon - lng);
                  const distMiles = Math.sqrt(dLat*dLat + dLng*dLng) * 69;
                  
                  state.nearbyPlaces.push({ 
                    name: name, 
                    type: type, 
                    address: address || type,
                    distance: distMiles < 0.1 ? 'Very close' : `~${distMiles.toFixed(1)} mi`
                  });
                }
              });
            }
          } catch (e) {}
        }
        
        if (state.nearbyMode === 'water') {
          const directions = [
            { name: 'North', lat: lat + 0.007, lng: lng },
            { name: 'South', lat: lat - 0.007, lng: lng },
            { name: 'East', lat: lat, lng: lng + 0.009 },
            { name: 'West', lat: lat, lng: lng - 0.009 }
          ];
          
          for (const dir of directions) {
            try {
              const response = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${dir.lat}&lon=${dir.lng}&zoom=14`
              );
              const data = await response.json();
              if (data && data.display_name) {
                const name = data.address?.town || data.address?.city || data.address?.village || data.address?.suburb || data.display_name.split(',')[0];
                if (!state.nearbyPlaces.find(p => p.name === name)) {
                  state.nearbyPlaces.push({
                    name: name,
                    type: 'landmark',
                    address: `To the ${dir.name}`,
                    distance: '~0.5 mi'
                  });
                }
              }
            } catch (e) {}
          }
        }
        
        state.nearbyPlaces.sort((a, b) => {
          if (a.distance === 'Very close') return -1;
          if (b.distance === 'Very close') return 1;
          return parseFloat(a.distance) - parseFloat(b.distance);
        });
        
        state.nearbyPlaces = state.nearbyPlaces.slice(0, 10);
        
        if (state.nearbyPlaces.length === 0) {
          state.nearbyPlaces = [{ name: 'No places found nearby', type: 'info', address: 'Try switching modes', distance: '' }];
        }
        
      } catch (e) {
        console.error('Error fetching nearby:', e);
        state.nearbyPlaces = [{ name: 'Could not load nearby places', type: 'error', address: 'Try again later', distance: '' }];
      }
      
      state.loadingNearby = false;
      render();
    }

    function toggleNearbyMode() {
      state.nearbyMode = state.nearbyMode === 'water' ? 'land' : 'water';
      fetchNearbyPlaces();
    }

    function openGoogleMaps() {
      if (state.location) {
        window.open(`https://www.google.com/maps?q=${state.location.lat},${state.location.lng}`, '_blank');
      }
    }

    function getLocation() {
      state.loading = true;
      state.error = null;
      render();

      if (!navigator.geolocation) {
        state.error = 'Geolocation not supported';
        state.loading = false;
        render();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
            const data = await response.json();
            
            state.location = {
              address: data.display_name || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,
              city: data.address?.city || data.address?.town || data.address?.village || 'Unknown',
              state: data.address?.state || '',
              lat: latitude,
              lng: longitude
            };
            
            // Find nearest named location
            state.nearestLocation = findNearestLocation(latitude, longitude);
            
            // Check if on water
            state.onWater = checkIfOnWater(latitude, longitude);
            
            // Auto-activate boat mode if near boat launch
            if (state.nearestLocation?.isBoat && !state.boatModeActive) {
              state.boatModeActive = true;
              state.nearbyMode = 'water';
            }
            
          } catch (e) {
            state.location = {
              address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,
              city: 'Unknown',
              state: '',
              lat: latitude,
              lng: longitude
            };
          }
          state.loading = false;
          render();
        },
        (error) => {
          state.location = {
            address: '540 N Tamiami Trail, Sarasota, FL 34236',
            city: 'Sarasota',
            state: 'Florida',
            lat: 27.3412,
            lng: -82.5463
          };
          state.nearestLocation = findNearestLocation(27.3412, -82.5463);
          state.loading = false;
          render();
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    function toggleDetails() {
      state.showDetails = !state.showDetails;
      state.showNearby = false;
      state.showApps = false;
      render();
    }

    function toggleApps() {
      state.showApps = !state.showApps;
      state.showDetails = false;
      state.showNearby = false;
      render();
    }

    function toggleNearby() {
      if (!state.showNearby) {
        fetchNearbyPlaces();
      } else {
        state.showNearby = false;
        render();
      }
    }

    function getTimeInfo() {
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const day = now.toLocaleDateString([], { weekday: 'long' });
      return { time, day };
    }

    function render() {
      const { time, day } = getTimeInfo();
      const app = document.getElementById('app');
      const currentApps = getAppsForLocation();
      
      const speakButtons = isSpeaking ? `
        <button onclick="stopSpeaking()" class="flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
          <i data-lucide="square" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Stop</span>
        </button>
      ` : `
        <button onclick="readAreaDescription()" class="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg transition-colors">
          <i data-lucide="volume-2" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Read Aloud</span>
        </button>
        <button onclick="readAloudSpeechify()" class="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
          <i data-lucide="external-link" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Speechify</span>
        </button>
      `;
      
      // Location display name
      const locationName = state.nearestLocation 
        ? `${state.nearestLocation.name} ${state.nearestLocation.distance < 0.1 ? '' : `(${state.nearestLocation.distance.toFixed(1)} mi away)`}`
        : `${state.location?.city || 'Unknown'}, ${state.location?.state || ''}`;
      
      app.innerHTML = `
        <div class="max-w-md mx-auto space-y-4">
          <div class="text-center pt-4 pb-2">
            <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent">
              Where Am I?
            </h1>
            <p class="text-slate-400 text-sm mt-1">${time} â€¢ ${day}</p>
          </div>

          <!-- Location Card -->
          <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-5 border border-slate-700/50">
            <div class="flex items-start gap-4">
              <div class="p-3 rounded-xl" style="background: linear-gradient(135deg, ${state.nearestLocation?.color || '#06b6d4'}, ${state.nearestLocation?.color || '#3b82f6'})">
                <i data-lucide="${state.nearestLocation?.icon || 'map-pin'}" class="w-6 h-6"></i>
              </div>
              <div class="flex-1 min-w-0">
                ${state.loading ? `
                  <div class="h-5 bg-slate-700 rounded w-32 mb-2 animate-pulse"></div>
                  <div class="h-4 bg-slate-700 rounded w-48 animate-pulse"></div>
                ` : `
                  <h2 class="font-semibold text-lg truncate">${state.nearestLocation?.name || state.location?.city || 'Unknown'}</h2>
                  <p class="text-slate-400 text-sm truncate">${state.nearestLocation ? (state.nearestLocation.distance < 0.1 ? 'You are here' : `${state.nearestLocation.distance.toFixed(2)} mi away`) : state.location?.address || 'Getting location...'}</p>
                `}
              </div>
              <button onclick="getLocation()" class="p-2 hover:bg-slate-700 rounded-lg transition-all ${state.loading ? 'animate-spin' : ''}">
                <i data-lucide="refresh-cw" class="w-5 h-5 text-slate-400"></i>
              </button>
            </div>
            
            ${state.boatModeActive ? `
              <div class="mt-3 flex items-center justify-between p-2 bg-blue-500/20 rounded-lg border border-blue-500/30">
                <div class="flex items-center gap-2">
                  <i data-lucide="anchor" class="w-4 h-4 text-blue-400"></i>
                  <span class="text-blue-300 text-sm font-medium">Boat Mode Active</span>
                </div>
                <button onclick="deactivateBoatMode()" class="text-xs bg-blue-500/30 hover:bg-blue-500/50 px-2 py-1 rounded text-blue-200">
                  End Trip
                </button>
              </div>
            ` : ''}
          </div>

          ${state.nearestLocation?.isBoat && !state.boatModeActive ? `
          <!-- Start Boat Trip Button -->
          <button onclick="activateBoatMode()" 
                  class="w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-400 hover:to-cyan-500 rounded-2xl p-4 text-center transition-all active:scale-[0.98]">
            <div class="flex items-center justify-center gap-3">
              <i data-lucide="anchor" class="w-6 h-6"></i>
              <span class="font-semibold text-lg">Start Boat Trip</span>
            </div>
            <p class="text-blue-100 text-sm mt-1">Activates boat mode & water apps</p>
          </button>
          ` : ''}

          <!-- My Apps Button -->
          <button onclick="toggleApps()" 
                  class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 rounded-2xl p-4 text-left transition-all active:scale-[0.98]">
            <div class="flex items-center gap-4">
              <div class="p-3 bg-white/20 rounded-xl">
                <i data-lucide="grid-3x3" class="w-6 h-6"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-lg">My Apps</h3>
                <p class="text-emerald-100 text-sm">${state.nearestLocation ? `Apps for ${state.nearestLocation.name}` : 'Quick access to your apps'}</p>
              </div>
              <i data-lucide="chevron-right" class="w-6 h-6 transition-transform ${state.showApps ? 'rotate-90' : ''}"></i>
            </div>
          </button>

          ${state.showApps ? `
          <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700/50 slide-in">
            <div class="grid grid-cols-3 gap-3">
              ${currentApps.map((app, idx) => `
                <button onclick="openApp(ALL_APPS.find(a => a.name === '${app.name}'))" 
                        class="flex flex-col items-center gap-2 p-3 ${idx < (state.nearestLocation?.apps?.length || 3) ? 'bg-emerald-500/20 border border-emerald-500/30' : 'bg-slate-700/30'} hover:bg-slate-600/50 rounded-xl transition-colors">
                  <div class="p-2 rounded-lg" style="background-color: ${app.color}30">
                    <i data-lucide="${app.icon}" class="w-5 h-5" style="color: ${app.color}"></i>
                  </div>
                  <span class="text-xs font-medium text-center truncate w-full">${app.name}</span>
                </button>
              `).join('')}
            </div>
          </div>
          ` : ''}

          <!-- Two Discovery Buttons -->
          <div class="grid grid-cols-2 gap-3">
            <button onclick="toggleDetails()" 
                    class="bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 rounded-2xl p-4 text-left transition-all active:scale-[0.98]">
              <div class="flex flex-col items-center text-center gap-2">
                <div class="p-3 bg-white/20 rounded-xl">
                  <i data-lucide="globe" class="w-6 h-6"></i>
                </div>
                <div>
                  <h3 class="font-semibold">About Area</h3>
                  <p class="text-cyan-100 text-xs">City overview</p>
                </div>
              </div>
            </button>
            <button onclick="toggleNearby()" 
                    class="bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-400 hover:to-pink-500 rounded-2xl p-4 text-left transition-all active:scale-[0.98]">
              <div class="flex flex-col items-center text-center gap-2">
                <div class="p-3 bg-white/20 rounded-xl">
                  <i data-lucide="radar" class="w-6 h-6"></i>
                </div>
                <div>
                  <h3 class="font-semibold">What's Nearby</h3>
                  <p class="text-purple-100 text-xs">Places & POIs</p>
                </div>
              </div>
            </button>
          </div>

          ${state.showDetails ? `
          <div class="space-y-4 slide-in">
            <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-5 border border-slate-700/50">
              <h3 class="font-semibold text-lg flex items-center gap-2 mb-3">
                <i data-lucide="info" class="w-5 h-5 text-cyan-400"></i>
                About ${state.location?.city || 'This Area'}
              </h3>
              <p class="text-slate-300 text-sm leading-relaxed">${AREA_DESCRIPTION}</p>
              <div class="flex gap-2 mt-3 flex-wrap">
                <span class="px-3 py-1 bg-cyan-500/20 text-cyan-300 rounded-full text-xs">Beaches</span>
                <span class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-xs">Arts & Culture</span>
                <span class="px-3 py-1 bg-emerald-500/20 text-emerald-300 rounded-full text-xs">Dining</span>
                <span class="px-3 py-1 bg-orange-500/20 text-orange-300 rounded-full text-xs">Nature</span>
              </div>
              <div class="flex gap-2 mt-4 flex-wrap">
                ${speakButtons}
              </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-5 border border-slate-700/50">
              <h3 class="font-semibold text-lg mb-3 flex items-center gap-2">
                <i data-lucide="navigation" class="w-5 h-5 text-cyan-400"></i>
                Area Highlights
              </h3>
              <div class="space-y-3">
                ${LOCAL_SUGGESTIONS.map(place => `
                  <div class="flex items-center gap-3 p-3 bg-slate-700/30 rounded-xl">
                    <div class="p-2 bg-slate-600/50 rounded-lg">
                      <i data-lucide="${place.icon}" class="w-5 h-5 text-cyan-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium truncate">${place.name}</h4>
                      <p class="text-slate-400 text-xs truncate">${place.desc}</p>
                    </div>
                    <span class="text-slate-500 text-xs whitespace-nowrap">${place.distance}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          ` : ''}

          ${state.showNearby ? `
          <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-5 border border-slate-700/50 slide-in">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold text-lg flex items-center gap-2">
                <i data-lucide="radar" class="w-5 h-5 text-purple-400"></i>
                What's Nearby
              </h3>
              <div class="flex gap-2">
                <button onclick="toggleNearbyMode()" class="flex items-center gap-1 px-2 py-1 ${state.nearbyMode === 'water' ? 'bg-blue-500' : 'bg-slate-600'} rounded-lg text-xs">
                  <i data-lucide="${state.nearbyMode === 'water' ? 'anchor' : 'building-2'}" class="w-3 h-3"></i>
                  ${state.nearbyMode === 'water' ? 'Boat' : 'Land'}
                </button>
              </div>
            </div>
            
            <button onclick="openGoogleMaps()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl mb-3 transition-colors">
              <i data-lucide="map" class="w-5 h-5"></i>
              <span class="font-medium">Open My Location in Google Maps</span>
            </button>
            
            <p class="text-slate-400 text-xs mb-2">${state.nearbyMode === 'water' ? 'Showing ~0.5 mi radius (boat mode)' : 'Showing ~0.25 mi radius'}</p>
            
            ${state.loadingNearby ? `
              <div class="space-y-3">
                <div class="h-12 bg-slate-700 rounded-xl animate-pulse"></div>
                <div class="h-12 bg-slate-700 rounded-xl animate-pulse"></div>
                <div class="h-12 bg-slate-700 rounded-xl animate-pulse"></div>
              </div>
            ` : `
              <div class="space-y-2">
                ${state.nearbyPlaces ? state.nearbyPlaces.map(place => `
                  <div class="flex items-center gap-3 p-3 bg-slate-700/30 rounded-xl">
                    <div class="p-2 bg-purple-500/20 rounded-lg">
                      <i data-lucide="${
                        place.type === 'restaurant' || place.type === 'cafe' ? 'utensils' :
                        place.type === 'shop' || place.type === 'store' ? 'shopping-bag' :
                        place.type === 'marina' || place.type === 'dock' || place.type === 'pier' ? 'anchor' :
                        place.type === 'beach' ? 'waves' :
                        place.type === 'park' ? 'tree-pine' :
                        place.type === 'gas' ? 'fuel' :
                        place.type === 'landmark' || place.type === 'town' || place.type === 'village' ? 'landmark' :
                        'map-pin'
                      }" class="w-4 h-4 text-purple-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-sm truncate">${place.name}</h4>
                      <p class="text-slate-400 text-xs truncate">${place.address}</p>
                    </div>
                    <span class="text-slate-500 text-xs whitespace-nowrap">${place.distance}</span>
                  </div>
                `).join('') : '<p class="text-slate-400 text-sm">No nearby places found</p>'}
              </div>
            `}
          </div>
          ` : ''}

          <!-- Quick Actions -->
          <div class="grid grid-cols-4 gap-2">
            <button onclick="window.open('geo:${state.location?.lat || 0},${state.location?.lng || 0}')" 
                    class="bg-slate-800/50 backdrop-blur rounded-xl p-3 border border-slate-700/50 active:bg-slate-700/50 transition-colors flex flex-col items-center">
              <i data-lucide="map" class="w-5 h-5 text-cyan-400 mb-1"></i>
              <span class="font-medium text-xs">Maps</span>
            </button>
            <button onclick="window.open('geo:0,0?q=restaurants')" 
                    class="bg-slate-800/50 backdrop-blur rounded-xl p-3 border border-slate-700/50 active:bg-slate-700/50 transition-colors flex flex-col items-center">
              <i data-lucide="utensils" class="w-5 h-5 text-orange-400 mb-1"></i>
              <span class="font-medium text-xs">Food</span>
            </button>
            <button onclick="window.open('geo:0,0?q=coffee')" 
                    class="bg-slate-800/50 backdrop-blur rounded-xl p-3 border border-slate-700/50 active:bg-slate-700/50 transition-colors flex flex-col items-center">
              <i data-lucide="coffee" class="w-5 h-5 text-amber-400 mb-1"></i>
              <span class="font-medium text-xs">Coffee</span>
            </button>
            <button onclick="window.open('geo:0,0?q=gas+station')" 
                    class="bg-slate-800/50 backdrop-blur rounded-xl p-3 border border-slate-700/50 active:bg-slate-700/50 transition-colors flex flex-col items-center">
              <i data-lucide="fuel" class="w-5 h-5 text-emerald-400 mb-1"></i>
              <span class="font-medium text-xs">Gas</span>
            </button>
          </div>

          <p class="text-center text-slate-500 text-xs pb-4">
            Tap refresh to update your location
          </p>
        </div>
      `;

      lucide.createIcons();
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('SW registration failed:', err));
    }

    getLocation();
  </script>
</body>
</html>
